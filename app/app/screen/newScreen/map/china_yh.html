<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <title>World</title>
    <script src="https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.1.1/jquery.slim.min.js"></script>
    <script charset="utf-8" src="js/d3.min.js"></script>
    <script charset="utf-8" src="js/tooltip.js"></script>
    <script charset="utf-8" src="js/province2.js"></script>
    <script charset="utf-8" src="js/queue.v1.js"></script>
    <script charset="utf-8" src="js/utils.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js" charset="utf-8"></script>
</head>

<body>
    <style>
    html,
    body {
        padding: 0;
        margin: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
        /*background: #222234;*/
        /*background: url("images/bgimg1.jpg")no-repeat;*/
    }
    
    body > div {
        position: absolute;
        overflow: hidden;
    }
    
    #map {
        left: 0;
        top: 0;
        z-index: 0;
        width: 100%;
        height: 100%;
    }
    
    #map svg {
        width: 100%;
        height: 100%;
    }
    
    #map .feature {
        fill: #2C2C43;
        stroke: #4A4A70;
    }
    
    .province {
        stroke: white;
        stroke-width: 1px;
    }
    
    .southsea {
        stroke: #fff;
        stroke-width: 1px;
        fill: rgb(5, 213, 232);
    }
    
    .route {
        stroke: black;
        stroke-width: 3px;
        fill: black;
    }
    
    #c {
        left: 0;
        top: 0;
        z-index: 1;
    }
    
    #s {
        left: 0;
        top: 0;
        z-index: 2;
    }
    
    .gtLeg,
    .gttLeg {
        fill: #f9f9f9;
        text-shadow: 0 1px 2px rgba(0, 0, 0, .5);
    }
    
    .com-mess {
        font-size: 11pt;
        font-family: Verdana, serif;
        fill: #ffffff;
        fill-opacity: .3;
    }
    
    #pb {
        left: 0;
        bottom: 0;
        position: fixed;
        z-index: 100;
        height: auto;
        font-size: 10px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, .8);
    }
    
    #menu {
        top: 2px;
        left: 2px;
        z-index: 50;
        position: fixed;
    }
    
    #info {
        right: 2px;
        top: 2px;
        z-index: 51;
        position: fixed;
    }
    
    ul {
        padding: 0;
        margin: 0;
        list-style: none;
        background: rgba(69, 91, 115, .6);
        border: 1px solid rgba(147, 168, 190, .8);
        color: rgba(147, 168, 190, 1);
        text-shadow: 0 1px 2px rgba(0, 0, 0, .8);
        border-radius: 5px;
        overflow: hidden;
        vertical-align: middle;
    }
    
    li {
        margin: 0;
        padding: 4px 2px;
        margin-right: 2px;
        overflow: hidden;
        vertical-align: middle;
        display: inline-block;
    }
    
    img {
        display: inline-block;
    }
    
    li:last-child {
        margin-right: 0;
    }
    
    .btn {
        cursor: pointer;
        -moz-box-shadow: inset 0 1px 0 0 #ffffff;
        -webkit-box-shadow: inset 0 1px 0 0 #ffffff;
        box-shadow: inset 0 1px 0 0 #ffffff;
        background: -webkit-gradient( linear, left top, left bottom, color-stop(0.05, #f9f9f9), color-stop(1, #e9e9e9));
        background: -moz-linear-gradient( center top, #f9f9f9 5%, #e9e9e9 100%);
        filter: progid: DXImageTransform.Microsoft.gradient(startColorstr='#f9f9f9', endColorstr='#e9e9e9');
        background-color: #f9f9f9;
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        border: 1px solid #dcdcdc;
        display: inline-block;
        color: #738eab;
        font-family: 'Times New Roman' serif;
        font-size: 14px;
        font-weight: normal;
        padding: 4px 8px;
        text-decoration: none;
        text-shadow: 0 1px 1px #ffffff;
    }
    
    .btn:hover {
        background: -webkit-gradient( linear, left top, left bottom, color-stop(0.05, #e9e9e9), color-stop(1, #f9f9f9));
        background: -moz-linear-gradient( center top, #e9e9e9 5%, #f9f9f9 100%);
        filter: progid: DXImageTransform.Microsoft.gradient(startColorstr='#e9e9e9', endColorstr='#f9f9f9');
        background-color: #e9e9e9;
    }
    
    .btn:active {
        background: -webkit-gradient( linear, left top, left bottom, color-stop(0.05, #DCDCDC), color-stop(1, #f9f9f9));
        background: -moz-linear-gradient( center top, #DCDCDC 5%, #f9f9f9 100%);
        filter: progid: DXImageTransform.Microsoft.gradient(startColorstr='#DCDCDC', endColorstr='#f9f9f9');
        background-color: #e9e9e9;
        position: relative;
        /*top:1px;*/
        color: #587493;
        text-shadow: 0 -1px 1px #ffffff;
    }
    /* This imageless css button was generated by CSSButtonGenerator.com */
    
    .tooltip {
        padding: .5em;
        background: rgba(33, 63, 66, .2);
        color: #fff;
        /*text-shadow: 0 1px 2px rgba(0, 0, 0, .8);*/
        border: none;
        line-height: 1.5em;
        /*box-shadow: 0 0 8px rgba(0, 0, 0, .5);*/
        z-index: 999;
        font-family: serif;
        font-size: 15px;
    }
    
    .tooltip_pro {
        padding: .5em;
        background: rgba(33, 63, 66, .2);
        color: #fff;
        /*text-shadow: 0 1px 2px rgba(0, 0, 0, .8);*/
        border: none;
        line-height: 1.5em;
        /*box-shadow: 0 0 8px rgba(0, 0, 0, .5);*/
        z-index: 999;
        font-family: serif;
        font-size: 15px;
        position: absolute;
        transition: all 0.5s;
        -moz-transition: all 0.5s;
        /* Firefox 4 */
        -webkit-transition: all 0.5s;
        /* Safari ? Chrome */
        -o-transition: all 0.5s;
        /* Opera */
        transition-delay: 0.8s;
        -moz-transition-delay: 0.8s;
        /* Firefox 4 */
        -webkit-transition-delay: 0.8s;
        /* Safari ? Chrome */
        -o-transition-delay: 0.8s;
        /* Opera */
        /*width: 300px;height: 200px;background: red;position: absolute;*/
    }
    
    .ceitip {
        padding: .5em;
        background: rgba(33, 63, 66, .2);
        color: #fff;
        /*text-shadow: 0 1px 2px rgba(0, 0, 0, .8);*/
        border: none;
        line-height: 1.5em;
        /*box-shadow: 0 0 8px rgba(0, 0, 0, .5);*/
        z-index: 999;
        font-family: serif;
        font-size: 15px;
        position: absolute;
    }
    
    #info li {
        border: 0;
        border-right: 1px dotted rgba(115, 142, 171, 1);
        padding-right: 5px;
        cursor: pointer;
    }
    
    #info li ul {
        display: none;
        border-radius: 0;
        background: rgba(244, 244, 244, .6);
        border: 1px dotted rgba(75, 75, 0, .8);
        color: #f9f9f9;
        text-shadow: 0 2px 2px rgba(0, 0, 0, .8);
    }
    
    #info li li {
        display: block;
        border: 0;
        padding-right: 2px;
    }
    
    #info li:last-child {
        border: 0;
    }
    
    #info li:hover ul {
        display: block;
    }
    
    .linkShow {
        width: 45px;
        height: 45px;
        margin: 10px 0;
        cursor: pointer;
        background: url("./images/link.png")no-repeat;
        background-size: 32px;
        background-position: 6px;
        background-color: #1f4352;
        position: fixed;
        right: 115px;
        top: 422px;
        z-index: 20;
    }
    
    .trsinfo {
        position: absolute;
        display: block;
        z-index: 99999;
        background: rgba(0, 0, 0, 0.45);
        color: white;
        font-size: 15pt;
        font-weight: bold;
        max-height: 50px;
        width: 0;
        white-space: nowrap;
        line-height: 25px;
        border-radius: 10px;
        overflow: hidden;
        padding: 5px 10px;
        text-align: center;
        transition: width 2s;
        -moz-transition: width 2s;
        /* Firefox 4 */
        -webkit-transition: width 2s;
        /* Safari ? Chrome */
        -o-transition: width 2s;
        /* Opera */
    }
    
    .trsinfo:after,
    .trsinfo:before {
        transition: width 2s;
        -moz-transition: width 2s;
        /* Firefox 4 */
        -webkit-transition: width 2s;
        /* Safari ? Chrome */
        -o-transition: width 2s;
        /* Opera */
    }
    
    .triangle {
        width: 0;
        height: 0;
        position: absolute;
        border-top: 10px solid rgba(0, 0, 0, 0.45);
        border-left: 7px solid transparent;
        border-right: 7px solid transparent;
        /* width: 100%; */
        /*margin-left: 40%;*/
    }
    </style>
    <!--<div class="linkShow" data-link="1"></div>-->
    <div class="tooltip_pro" style="display: none">
    </div>
    <canvas id="canvas" style="position: relative;z-index:-1"></canvas>
    <script src="js/trsinfo.js"></script>
    <script src="js/snap.svg.js"></script>
    <!-- 增加根据类别获取相对应的颜色-->
    <script src="js/getColor.js"></script>
    <script src="js/chinaMap.js"></script>
    <!-- <script src="js/bg.js"></script> -->
    <script>
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }
    </script>
    <script>
    (function(window) {
        var lastTime = 0;
        var vendors = ['ms', 'moz', 'webkit', 'o'];
        for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
            window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
            window.cancelAnimationFrame =
                window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];
        }

        if (!window.requestAnimationFrame)
            window.requestAnimationFrame = function(callback, element) {
                var currTime = new Date().getTime();
                var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                var id = window.setTimeout(function() {
                        callback(currTime + timeToCall);
                    },
                    timeToCall);
                lastTime = currTime + timeToCall;
                return id;
            };

        if (!window.cancelAnimationFrame)
            window.cancelAnimationFrame = function(id) {
                clearTimeout(id);
            };
    })(window);

    var vis = {},
        cat = 'Major Sector',
        influenceValue;

    var setting = {
        childLife: 0 // 2
            ,
        parentLife: 0 // number of steps of life a parent
            ,
        showCountExt: true // show table of child's extension
            ,
        onlyShownExt: true // show only extension which is shown
            ,
        showHistogram: true // displaying histogram of changed files
            ,
        showHalo: true // show a child's halo
            ,
        padding: 0 // padding around a parent
            ,
        rateOpacity: .5 // rate of decrease of opacity
            ,
        rateFlash: 2.5 // rate of decrease of flash
            ,
        sizeChild: 2 // size of child
            ,
        sizeParent: 5 // size of parent
            ,
        showPaddingCircle: true // show circle of padding
            ,
        useImage: true // show base's image
            ,
        showChild: true // show a child
            ,
        showParent: false // show a parent
            ,
        showLabel: false // show base name
            ,
        showMessage: false // show commit message
            ,
        skipEmptyDate: true // skip empty date
            ,
        blendingLighter: true,
        showTrack: true // show tracks
            ,
        showEdge: false // show an edge
            ,
        groupByRegion: false,
        fadingTail: true
    };

    var asyncForEach = function(items, fn, Tn, time) {
        //time=100;
        if (!(items instanceof Array))
            return;

        var workArr = items.reverse().concat();

        function loop() {
            //渲染数据，把数组的第一个元素从其中删除，并返回第一个元素的值，用于绘制图形
            if (workArr.length > 0)
                fn(workArr.shift(), workArr);
            // Tn(workArr.shift());
            if (workArr.length > 0) {
                setTimeout(loop, time || 1);
            }
        }
        loop();
    };

    var shortTimeFormat = (function() {
        var fd = d3.time.format("%d.%b.%y");
        return function(ms) {
            return fd(new Date(ms /* - TIME_ZONE*/ ));
        }
    })();

    var ONE_SECOND = 1000,
        stepDate = 12 * 60 * 60 * 1000;

    var request, _DATA, projection, saveDATA, MAPDATA, HEBEIDATA, HEBEIfeature, newJSONURL = "/cas/xhs/articleDetail/main.do?method=getReprintByTime"; //"http://111.203.35.59/cas/xhs/articleDetail/main.do?method=getReprintByTime";//"json/newData.json";
    var LOADCOUNT = 0,
        showTip = true;

    showTip = getQueryString("showTip")||true;
    showTip = (showTip == 'false')?false:true;



    var newProvince;
    function getDATA(fn) {
        if (_DATA.length == 0) {
            //
            //return;
            if (LOADCOUNT > 1) {
                location.reload(true);
            }
            queue().defer(d3.json, newJSONURL)
                .await(function(error, data) {
                    var mapRecords = data.Records ? data.Records : data.RECORDS;
                    mapRecords.forEach(function(_data, index, array) {
                        var r = Math.ceil(Math.random() * 255);
                        var g = Math.ceil(Math.random() * 255);
                        var b = Math.ceil(Math.random() * 255);
                        _data['Major Sector'] = "rgb(" + r + "," + g + "," + b + ")";
                        // if(_data.length>0){
                        //   _data.forEach(function(_sData,_sIndex){
                        //       _sData['Major Sector']="rgb("+r+","+g+","+b+")";
                        //   });
                        // }
                    });
                    LOADCOUNT++;
                    _DATA = mapRecords.slice(0);
                    if (showTip) {
                        var _da = _DATA.pop();
                        if (!_da) {
                            getDATA(fn);
                            return;
                        }
                        fn([_da]);
                    } else {
                        fn(_DATA);
                        _DATA = [];
                    }
                });
            return;

        }
        if (showTip) {
            var _da = _DATA.pop();
            if (!_da) {
                getDATA(fn);
                return;
            }
            fn([_da]);
        } else {
            fn(_DATA);
            _DATA = [];
        }
    }

    (function(vis) {
        /*var ONE_SECOND = 1000,
         stepDate = 24 * 60 * 60 * 1000
         ;*/

        var PI_CIRCLE = Math.PI * 2;

        var _worker,
            _data,
            nodes,
            dateRange,
            selected,
            selectedExt,

            colorless = d3.rgb("gray"),
            colorlessFlash = d3.rgb("lightgray"),

            parentHash,
            childHash,
            extHash,
            extMax,

            _parentKey,
            _childKey,

            _force,
            _forceBase,

            links,
            regionLinks,

            lCom, lLeg, lHis,

            canvas, ctx,
            bufCanvas, bufCtx,
            layer,

            valid,
            pause,
            stop,

            particle,
            defImg,

            lastEvent,
            zoomScale,
            _w, _h,
            xW,
            yH,

            setting,
            rd3 = d3.random.irwinHall(8);

        var extColor = d3.scale.category20(),
            baseColor = d3.scale.category20b();

        var th = d3.format(",");

        var typeNode = {
            parent: 0,
            child: 1,
            region: 2
        };

        defImg = new Image();
        defImg.src = "images/second.png";

        particle = new Image();
        particle.src = "images/particle.png";
        //particle.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAARCAMAAADjcdz2AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAC7lBMVEUAAAA9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9Z4g9Z4g9Z4g9Z4g9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk/bY5Abo9Abo8/bY49aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk8ZYZUk7Znut1nut1Ulbc8Zoc9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk8ZYZTk7Vqv+Jqv+JUlLY8Zoc9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk/bI1CcpNCcpM/bI09aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9Z4g9Z4g9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIk9aIkAAAAILA2jAAAA+XRSTlMAFioAAAAAAAAAAAAAAAApFzG3RgAAJW2Tk20mAABDtzQAUYkJX7+TYmKSwGIIiFMAAAAHWb45AAAAADi9WwcAAAAAF7pEAAAAAAAAQrsYAAAATqkFAAAAAAAABKdRAABtigAAAAAAAAAAh3AAAGWTABF5i4t6EgCQaAAAN7kTDsKenMQQEbg6AAAABJ98AHt2c34AeaEFAAAADjQpt4B+k5CAf7grNA8AEJSQAh+v9N7d9LEhAY2WETOIFQAAcP////9zAAAUhzUCAgAAAHL/////dQAAAAICAAAAAABz6sfH6XYAAAAAAABHyKqqyEkAAAQ7VFQ8BADtDAuiAAAAAWJLR0QAiAUdSAAAAAlwSFlzAAAAZAAAAGQAD5bF3QAAAAd0SU1FB+AEGRcNEyp4hZEAAAEoSURBVBjTY2BkYmZhZWPn4OTi5uHl4xdgEBQSFhEVE5eQlJKWkZWTV2BQVFJWUVVT19DU0tbR1dM3YDA0MjYxNTO3sLSytrG1s3dgcHRydnF1c/fw9PL28fXzD2BgCAwKDgkNC4+IjIqOiY1jYGCIT0hMSk5JTUvPyMzKzgEK5OblFxQWFZeUlpVXVFYBBaprauvqGxqbmlta29o7GBg6u7p7evv6J0ycNHnK1GnTZzDMnDV7ztx58xcsXLR4ydJly1cwrFy1es3ades3bNy0ecvWbdt3MOzctXvP3n37Dxw8dPjI0WPHTzCcPHX6zNlz5y9cvHT5ytVr128w3Lx1+87de/cfPHz0+MnTZ89fMIDAy1ev37x99/4DAwx8/PT5y9dv33+A2ADF4nidSm7aegAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAxNi0wOS0xN1QxNToyMjoxMyswODowMEjbotEAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMTYtMDQtMjVUMjM6MTM6MTkrMDg6MDDUQ1zCAAAATXRFWHRzb2Z0d2FyZQBJbWFnZU1hZ2ljayA3LjAuMS02IFExNiB4ODZfNjQgMjAxNi0wOS0xNyBodHRwOi8vd3d3LmltYWdlbWFnaWNrLm9yZ93ZpU4AAABjdEVYdHN2Zzpjb21tZW50ACBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgINPdg9wAAAAYdEVYdFRodW1iOjpEb2N1bWVudDo6UGFnZXMAMaf/uy8AAAAYdEVYdFRodW1iOjpJbWFnZTo6SGVpZ2h0ADYxOG0eBMYAAAAXdEVYdFRodW1iOjpJbWFnZTo6V2lkdGgANTgxVLfpLwAAABl0RVh0VGh1bWI6Ok1pbWV0eXBlAGltYWdlL3BuZz+yVk4AAAAXdEVYdFRodW1iOjpNVGltZQAxNDYxNTk3MTk5JTf3dwAAABJ0RVh0VGh1bWI6OlNpemUAMzMuNUtCvI1LmAAAAF90RVh0VGh1bWI6OlVSSQBmaWxlOi8vL2hvbWUvd3d3cm9vdC9zaXRlL3d3dy5lYXN5aWNvbi5uZXQvY2RuLWltZy5lYXN5aWNvbi5jbi9zcmMvMTIwMDYvMTIwMDY1Mi5wbmfhLxTkAAAAAElFTkSuQmCC";
        //添加浮框
        function showDraft(d) {
            if (stop) {
                return;
            }
            var toolT = $('.tooltip_pro').clone();
            var res = [];

            if (!d) return;


            res = [
                d.img && d.img.width > 0 && d.img.height > 0 ? d.img.outerHTML : "",
                " 地区: <b>",
                '31313',
                "</b><hr/>影响?: <b>",
                th('3131')
                //                    "M.</b><br/>Borrowed ($): <b>",
                //                    th(d.nodeValue.borrowed),
                //                    "M.</b><br/>"
            ];
            //            }
            //

            //         toolT.html(res.join(''));
            //         toolT.css("display", "block");
            //         toolT.show();
            // //        toolT.css("position", "absoulte");
            // //        toolT.css("transform","translate:"+x+"px,"+y+"px");
            //         toolT.css("left",d.borrower.capitalCity.coord.x.valueOf()+"px");
            //         toolT.css("top",d.borrower.capitalCity.coord.y.valueOf()+"px");
            //         toolT.appendTo($("body"));

            //         setTimeout(function(){
            //             toolT.remove();
            //         },2000);

            new INFO("<font color='#ffe508' size='3'>" + d.mediaName + "</font>" + " " + new Date(d.pubTime).Format("MM-dd hh:mm"), d.title, 5000, d.borrower.capitalCity.coord.x.valueOf(), d.borrower.capitalCity.coord.y.valueOf()).show();
        }

        Date.prototype.Format = function(fmt) { //author: meizz
            var o = {
                "M+": this.getMonth() + 1, //月份
                "d+": this.getDate(), //?
                "h+": this.getHours(), //小时
                "m+": this.getMinutes(), //?
                "s+": this.getSeconds(), //?
                "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                "S": this.getMilliseconds() //毫秒
            };
            if (/(y+)/.test(fmt))
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (var k in o)
                if (new RegExp("(" + k + ")").test(fmt))
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
        };
        //    画圆?
        function reCalc(d) {
            if (stop)
                return;

            //lCom.showMessage(d.supplier.shortName + ' to ' + d.borrower.shortName + ' -> ' + d.project.name);

            var l = d.nodes.length,
                n, a, fn;
            //console.log(d.nodes);
            a = d.parentNode;
            a.relations = a.relations || {};
            a.fixed = a.x instanceof Object || a.y instanceof Object ? true : false;
            if (!l)
                console.log(d);
            else {
                a.alive = setting.parentLife > 0 ? setting.parentLife : 1;
                a.opacity = 100;
                a.flash = 100;
                a.visible = true;
            }
            while (--l > -1) {
                n = d.nodes[l];
                //            console.log(d.nodes[1])
                if (n.fixed) {
                    //n.x = xW(n.x);
                    //n.y = yH(n.y);
                    n.x = a.x;
                    n.y = a.y;
                    n.paths = [{
                        x: n.x,
                        y: n.y
                    }];
                    n.msize = n.size;
                    n.size *= 3;
                } else {
                    n.size = n.hasOwnProperty("msize") ? n.msize : n.size;
                    delete n["msize"];
                }



                //n.size += 2;
                n.fixed = false;

                n.parent = a;

                n.visible = true;
                fn = _childKey(n.nodeValue);

                n.flash = 100;
                n.opacity = 100;
                n.alive = setting.childLife > 0 ? setting.childLife : 1;

                if (n.visible) {
                    n.ext.now.indexOf(fn) < 0 && n.ext.now.push(fn);
                } else {
                    (fn = n.ext.now.indexOf(fn)) > -1
                        && n.ext.now.splice(parseInt(fn), 1);

                    n.flash *= .5;
                    n.alive *= .2;
                    n.opacity *= .5;
                }


                //            console.log(a);
                //            console.log(n);
                var key = a.id + "_" + n.id,
                    src = a,
                    trg = n,
                    bid = _parentKey(n.nodeValue.borrower),
                    sid = _parentKey(n.nodeValue.supplier)

                ;

                if (a.id != bid && !a.relations.hasOwnProperty(bid)) {
                    a.relations[bid] = n.nodeValue.borrower;
                } else if (a.id != sid && !a.relations.hasOwnProperty(sid)) {
                    a.relations[sid] = n.nodeValue.supplier;
                }

                if (n.nodeValue.borrower == a.nodeValue) {
                    key = n.id + "_" + a.id;
                    src = n;
                    trg = a;
                }

                if (!links.has(key))
                    links.set(key, {
                        key: key,
                        source: src,
                        target: trg
                    });

                if (n.nodeValue.supplier == n.nodeValue.borrower) {
                    key = n.id + "_" + a.id;
                    if (!links.has(key))
                        links.set(key, {
                            key: key,
                            source: trg,
                            target: src
                        });
                }
            }

            updateLegend( /*d.sha*/ );

            _force.nodes(nodes.filter(function(d) {
                    return d.type != typeNode.parent && (d.visible || d.opacity);
                }) //.sort(sortBySize)
            ).start();

            _forceBase.nodes(nodes.filter(function(d) {
                if (d.type == typeNode.region) {
                    d.alive = 1;
                    d.opacity = 100;
                    d.flash = 100;
                }
                return (d.type == typeNode.parent || (setting.groupByRegion && d.type == typeNode.region)) && (d.visible || d.opacity);
            })).start();
        }

        function loop() {
            if (stop) {
                clearTimeout(_worker);
                return;
            }

            if (pause) {
                clearTimeout(_worker);
                _worker = setTimeout(loop, ONE_SECOND);
                return;
            }

            var dl, dr;

            dl = dateRange[0];
            dr = dl + stepDate;
            dateRange[0] = dr;


            var visTurn = _data.filter(function(d) {
                return d.date >= dl && d.date < dr;
            });




            asyncForEach(visTurn, reCalc, function() {}, ONE_SECOND / (visTurn.length > 1 ? visTurn.length : ONE_SECOND));


            if (dl >= dateRange[1]) {
                updateExtHistogram();
                if (typeof _worker !== "undefined") {
                    clearTimeout(_worker);
                }

                setTimeout(function() {
                    getDATA(function(data) {
                        request(null, data);
                    })
                }, 4000);
                return;
            } else {
                if (!visTurn.length && setting.skipEmptyDate) {
                    if (typeof _worker !== "undefined") {
                        clearTimeout(_worker);
                    }
                    loop();
                    return;
                }
            }


            updateExtHistogram();
            if (typeof _worker !== "undefined") {
                clearTimeout(_worker);
            }
            _worker = setTimeout(loop, ONE_SECOND);
        }

        function run() {
            if (typeof _worker !== "undefined")
                clearTimeout(_worker);

            render();
            //setInterval(render,50);
            //        setInterval(render,1);
            _worker = setTimeout(loop, ONE_SECOND);
        }

        function nr(d) {
            return d.size > 0 ? d.size : 0;
        }

        function curColor(d) {
            //        console.log(d)
            var ext = selectedExt;

            if (!ext && selected) {
                if (selected.type == typeNode.parent) {
                    return d.nodeValue.borrower !== selected.nodeValue && d.nodeValue.supplier !== selected.nodeValue ? d.flash ? colorlessFlash : colorless : d.flash ? d.flashColor : d.d3color;
                }
                if (selected.ext)
                    ext = selected.ext;
            }

            return ext && ext.color && ext.color !== d.d3color ? d.flash ? colorlessFlash : colorless : d.flash ? d.flashColor : d.d3color;
        }

        function curOpacityParent(d) {
            if (selected && selected.type == typeNode.parent) {
                return selected != d && !selected.relations[_parentKey(d.nodeValue)] ? 20 : d.opacity;
            }

            return selected && selected.type == typeNode.child && selected.nodeValue.borrower !== d.nodeValue && selected.nodeValue.supplier !== d.nodeValue ? 20 : d.opacity;
        }

        function curOpacity(d) {
            if (d.type == typeNode.parent)
                return curOpacityParent(d);

            var ext = selectedExt;

            if (!ext && selected) {
                if (selected.type == typeNode.parent) {
                    return d.nodeValue.borrower !== selected.nodeValue && d.nodeValue.supplier !== selected.nodeValue ? 20 : d.opacity;
                }
                if (selected.ext)
                    ext = selected.ext;
            }

            return ext && ext.color && ext.color !== d.d3color ? 20 : d.opacity;
        }

        function randomTrue() {
            return Math.floor(rd3() * 8) % 2;
        }

        function radius(d) {
            return Math.sqrt(d);
        }

        function contain(d, pos) {
            var px = (lastEvent.translate[0] - pos[0]) / lastEvent.scale,
                py = (lastEvent.translate[1] - pos[1]) / lastEvent.scale,
                r = Math.sqrt(Math.pow(d.x + px, 2) +
                    Math.pow(d.y + py, 2));

            return r < (d.type == typeNode.parent ? nr(d) * 1.5 : radius(nr(d)));
        }

        function getNodeFromPos(pos) {
            for (var i = nodes.length - 1; i >= 0; i--) {
                var d = nodes[i];
                if (d.visible && contain(d, pos))
                    return d;
            }
            return null;
        }

        function node(d, type) {
            var c = type == typeNode.child ? d[cat] : extColor(baseColor(d.key)),
                ext, x, y,
                w2 = _w / 2,
                w5 = _w / 5,
                h2 = _h / 2,
                h5 = _h / 5;
            if (type == typeNode.child) {
                ext = extHash.get(c);
                if (!ext) {
                    ext = {
                        all: 0,
                        currents: {},
                        values: {},
                        //                    color : d3.rgb(extColor(c)),
                        now: []
                    };
                    extHash.set(c, ext);
                }
                ext.color = d3.rgb(c);
                ext.all++;
                c = ext.color;
            }

            x = _w * Math.random();
            y = _h * Math.random();

            if (type == typeNode.parent || type == typeNode.region) {
                if (randomTrue()) {
                    x = x > w5 && x < w2 ? x / 5 : x > w2 && x < _w - w5 ? _w - x / 5 : x;
                } else {
                    y = y > h5 && y < h2 ? y / 5 : y > h2 && y < _h - h5 ? _h - y / 5 : y;
                }
                if (type == typeNode.parent) {
                    if (d.hasOwnProperty("x")) {
                        x = d.x;
                    }
                    if (d.hasOwnProperty("y")) {
                        y = d.y;
                    }
                }
            }

            return {
                x: x,
                y: y,
                id: type + (type == typeNode.child ? _childKey(d) : type == typeNode.region ? d : _parentKey(d)),
                size: type != typeNode.child ? type == typeNode.parent ? setting.sizeParent : 50 : d.size || 2,
                weight: type != typeNode.child ? 24 : d.size || 2,
                fixed: true,
                visible: type == typeNode.region,
                links: 0,
                type: type,
                color: c.toString(),
                d3color: c,
                flashColor: type == typeNode.child ? c.brighter().brighter() : c,
                ext: ext,
                parent: type == typeNode.parent ? d.key : null,
                img: type == typeNode.parent ? d.img : null,
                nodeValue: d
            }
        }

        function getBase(d) {
            if (!d || !d.parent)
                return null;

            var pkey = _parentKey(d.parent);

            var n = parentHash.get(pkey);

            if (!n) {
                n = node(d.parent, typeNode.parent);
                parentHash.set(pkey, n);
            }
            return n;
        }

        function getChild(d) {
            if (!d)
                return null;

            var key = _childKey(d);

            var n = childHash.get(key);

            if (!n) {
                n = node(d, typeNode.child);
                n.links = 1;
                childHash.set(key, n);
            }
            return n;
        }

        function initNodes(data) {
            var ns = [],
                i, j, n, d, df;
            parentHash = d3.map({});
            childHash = d3.map({});
            extHash = d3.map({});
            extMax = 0;

            if (data) {
                i = data.length;
                while (--i > -1) {
                    d = data[i];
                    if (!d) continue;
                    d.nodes = [];

                    n = getBase(d);
                    d.parentNode = n;
                    !n.inserted && (n.inserted = ns.push(n));

                    if (!d.parent.borrowed && !n.region) {
                        if (!parentHash.has("suppliers"))
                            parentHash.set("suppliers", node("suppliers", typeNode.region));
                        n.region = parentHash.get("suppliers");
                    } else {
                        if (!parentHash.has(d.Region))
                            parentHash.set(d.Region, node(d.Region, typeNode.region));
                        n.region = parentHash.get(d.Region);
                    }

                    n = getChild(d);
                    d.nodes.push(n);
                    n.ext.currents[shortTimeFormat(d.date)] = (n.ext.currents[shortTimeFormat(d.date)] || 0);
                    n.ext.currents[shortTimeFormat(d.date)]++;
                    n.ext.values['_' + d.id] = +d;
                    !n.inserted && (n.inserted = ns.push(n));

                    j = extHash.values().reduce((function(id) {
                        return function(a, b) {
                            return (a || 0) + (b.currents[id] || 0);
                        }
                    })(shortTimeFormat(d.date)), null);

                    extMax = j > extMax ? j : extMax;
                }
            }
            return ns;
        }

        var tempFileCanvas;
        var iiiii = 0;

        function colorize(img, r, g, b, a) {
            if (!img)
                return img;

            if (!tempFileCanvas)
                tempFileCanvas = document.createElement("canvas");

            if (tempFileCanvas.width != img.width)
                tempFileCanvas.width = img.width;

            if (tempFileCanvas.height != img.height)
                tempFileCanvas.height = img.height;

            var imgCtx = tempFileCanvas.getContext("2d"),
                imgData, i;
            imgCtx.clearRect(0, 0, _w, _h);
            imgCtx.drawImage(img, 0, 0);

            imgData = imgCtx.getImageData(0, 0, img.width, img.height);

            i = imgData.data.length;
            while ((i -= 4) > -1) {
                imgData.data[i + 3] = imgData.data[i] * a;
                if (imgData.data[i + 3]) {
                    imgData.data[i] = r;
                    imgData.data[i + 1] = g;
                    imgData.data[i + 2] = b;
                }
            }

            imgCtx.putImageData(imgData, 0, 0);

            delete imgData;
            return tempFileCanvas;
        }

        function blink(d, aliveCheck) {
            d.flash = (d.flash -= setting.rateFlash) > 0 ? d.flash : 0;

            !d.flash && aliveCheck && (d.alive = (d.alive-- > 0 ? d.alive : 0));

            d.opacity = !d.alive ? ((d.opacity -= setting.rateOpacity) > 0 ? d.opacity : 0) : d.opacity;

            d.visible && !d.opacity && (d.visible = false);

            if (d.paths) {
                d.pathLife = (d.pathLife || 0);
                if (d.pathLife++ > 0) {
                    d.pathLife = 0;
                    if (d.paths.length)
                        d.paths.shift();
                }
            }
        }

        function sortBySize(a, b) {
            return d3.ascending(a.size, b.size);
        }

        function checkVisible(d, offsetx, offsety) {
            var tx = lastEvent.translate[0] / lastEvent.scale,
                ty = lastEvent.translate[1] / lastEvent.scale;

            offsetx = offsetx || 0;
            if (!(offsetx instanceof Array))
                offsetx = [offsetx, offsetx];
            offsety = offsety || 0;
            if (!(offsety instanceof Array))
                offsety = [offsety, offsety];

            return (
                d.x + d.size > -tx + offsetx[0] && d.x - d.size < -tx + offsetx[1] + _w / lastEvent.scale && d.y + d.size > -ty + offsety[0] && d.y - d.size < -ty + offsety[1] + _h / lastEvent.scale
            );
        }

        function sortByColor(a, b) {
            return d3.ascending(b.color + !b.flash, a.color + !a.flash);
        }

        function sortByOpacity(a, b) {
            return d3.ascending(curOpacity(b), curOpacity(a));
        }

        function compereColor(a, b) {
            return a.r != b.r || a.g != b.g || a.b != b.b;
        }

        function filterVisible(d) {
            return checkVisible(d) && (d.visible || d.alive);
        }

        function redrawCanvas() {


            bufCtx.clearRect(0, 0, _w, _h);
            bufCtx.save();
            if (setting.blendingLighter && bufCtx.globalCompositeOperation == 'source-over') {
                bufCtx.globalCompositeOperation = 'lighter';
                //darker
            } else if (!setting.blendingLighter && bufCtx.globalCompositeOperation == 'lighter') {
                bufCtx.globalCompositeOperation = 'source-over';
            }

            bufCtx.translate(lastEvent.translate[0], lastEvent.translate[1]);
            bufCtx.scale(lastEvent.scale, lastEvent.scale);

            var n, l, i, j,
                src, trg,
                iw, ih,
                img,
                d, beg,
                c, x, y, s;


            if (setting.showEdge || selected) {
                n = links.entries();

                if (!setting.showEdge)
                    n = n.filter(function(d) {
                        return d.key.indexOf(selected.id) >= 0;
                    });

                l = n.length;

                bufCtx.save();
                bufCtx.lineCap = "round";
                bufCtx.lineJoin = "round";

                while (--l > -1) {
                    d = n[l].value;



                    src = d.source;
                    trg = d.target;
                    j = src.type == typeNode.child;

                    c = curColor(j ? src : trg);

                    bufCtx.beginPath();
                    bufCtx.strokeStyle = c.toString();
                    bufCtx.lineWidth = (radius(nr(d)) * 3) || 1;

                    var sx = j ? trg.x : src.x,
                        sy = j ? trg.y : src.y,
                        tx = !j ? trg.x : src.x,
                        ty = !j ? trg.y : src.y;

                    bufCtx.moveTo(sx, sy);
                    var x3 = .3 * ty - .3 * sy + .8 * sx + .2 * tx,
                        y3 = .8 * sy + .2 * ty - .3 * tx + .3 * sx,
                        x4 = .3 * ty - .3 * sy + .2 * sx + .8 * tx,
                        y4 = .2 * sy + .8 * ty - .3 * tx + .3 * sx;
                    bufCtx.bezierCurveTo(x3, y3, x4, y4, tx, ty); //贝塞尔曲?
                    bufCtx.stroke();
                }
                bufCtx.restore();
            }


            if (setting.showChild) {
                n = _force.nodes()
                    .filter(filterVisible)
                    .sort(sortBySize)
                    .sort(sortByOpacity)
                    .sort(sortByColor);

                l = n.length;

                c = null;
                i = 100;
                j = true;
                beg = false;

                bufCtx.globalAlpha = i * .01;
                while (--l > -1) {
                    d = n[l];

                    if (i != curOpacity(d)) {
                        i = curOpacity(d);
                        bufCtx.globalAlpha = i * .01;
                    }

                    if (!c || compereColor(c, curColor(d))) {
                        c = curColor(d);
                        //                    c=radomColor();
                        //                    console.log(c);
                        j = false;
                    }

                    if (!j) {
                        if (!setting.showHalo) {
                            if (beg) {
                                bufCtx.closePath();
                                bufCtx.fill();
                                bufCtx.stroke();
                            }

                            bufCtx.beginPath();
                            beg = true;
                            bufCtx.strokeStyle = "none";
                            bufCtx.fillStyle = c.toString();

                        } else {
                            //                        var color=radomColor();
                            //                        img = colorize(particle, color.r, color.g, color.b, 1);
                            if (d.type) {
                                c = (d3.rgb(getTypeColors("军事")));
                            }
                            img = colorize(particle, c.r, c.g, c.b, 1);
                        }

                        j = true;
                    }

                    x = Math.floor(d.x);
                    y = Math.floor(d.y);


                    if (setting.fadingTail && setting.showTrack) {
                        //bufCtx.save();
                        bufCtx.lineCap = "round";
                        //bufCtx.lineJoin="round";
                        bufCtx.lineWidth = (radius(nr(d)) / 4) || 1;
                        bufCtx.fillStyle = "none";
                        bufCtx.strokeStyle = c.toString();

                        var rs = d.paths.slice(0).reverse(),
                            lrs = rs.length,
                            cura = bufCtx.globalAlpha;
                        bufCtx.beginPath();
                        for (var p in rs) {
                            if (!rs.hasOwnProperty(p))
                                continue;


                            if (p < 1)
                                bufCtx.moveTo(x, y);
                            else
                                bufCtx.moveTo(
                                    Math.floor(rs[p - 1].x),
                                    Math.floor(rs[p - 1].y)
                                );
                            bufCtx.lineTo(
                                Math.floor(rs[p].x),
                                Math.floor(rs[p].y)
                            );
                            bufCtx.stroke();
                            bufCtx.globalAlpha = ((lrs - p) / lrs) * cura;
                        }
                        //bufCtx.restore();
                        bufCtx.globalAlpha = cura;
                    }

                    if (!setting.fadingTail && setting.showTrack) {
                        bufCtx.save();
                        bufCtx.beginPath();
                        bufCtx.lineCap = "round";
                        bufCtx.lineJoin = "round";
                        bufCtx.strokeStyle = c.toString();
                        bufCtx.lineWidth = (radius(nr(d)) / 4) || 1;

                        var rs = d.paths.slice(0).reverse(),
                            lrs = rs.length;

                        bufCtx.moveTo(x, y);
                        for (var p in rs) {
                            if (!rs.hasOwnProperty(p))
                                continue;

                            bufCtx.lineTo(
                                Math.floor(rs[p].x),
                                Math.floor(rs[p].y)
                            );
                        }
                        bufCtx.closePath();
                        bufCtx.stroke();
                        bufCtx.restore();
                    }

                    //                if(d.paths.slice(0).reverse().length>0){
                    d.size *= ((Math.random() * 0.04) + 1);
                    if (d.size > 15) {
                        d.size = 5;
                    }
                    s = radius(nr(d)) * 30;
                    bufCtx.beginPath();
                    bufCtx.drawImage(img, x - s / 2, y - s / 2, s, s);
                    bufCtx.drawImage(img, x - s / 2, y - s / 2, s, s);
                    bufCtx.closePath();
                    if (showTip && (Math.floor(d.px) != Math.floor(d.parent.x.valueOf()) || d.nodeValue.borrower.key == d.nodeValue.supplier.key) && !d.show) {
                        d.show = true;
                        showDraft(d.nodeValue, "show");
                    }

                    delete img;


                    //                     bufCtx.drawImage(img, x - s / 2+Math.random()*20, y - s / 2+Math.random()*20, s, s);
                    //}
                }
            }



            bufCtx.restore();
        }

        function render() {
            //        console.log("render")
            requestAnimationFrame(render);


            lHis && lHis.style("display", setting.showHistogram ? null : "none");
            lLeg && lLeg.style("display", setting.showCountExt ? null : "none");

            if (valid)
                return;

            valid = true;
            ctx.beginPath()
            ctx.save();
            ctx.clearRect(0, 0, _w, _h);

            redrawCanvas();
            //        setInterval(redrawCanvas,1000);
            ctx.drawImage(bufCanvas, 0, 0);
            ctx.restore();
            ctx.closePath();
            valid = false;
        }

        function tick() {
            if (_force.nodes()) {

                if (setting.groupByRegion)
                    _forceBase
                    .friction(.75)
                    .gravity(0)
                    .nodes()
                    .forEach(clusterParent(0.025));
                else
                    _forceBase
                    .friction(.9)
                    .gravity(setting.padding * .001);

                _force.nodes()
                    .forEach(cluster(0.025));

                _forceBase.nodes(
                    _forceBase.nodes()
                    .filter(function(d) {
                        blink(d, !d.links && setting.parentLife > 0);
                        if (d.visible && d.links === 0 && setting.parentLife > 0) {
                            d.flash = 0;
                            d.alive = d.alive / 10;
                        }
                        return d.visible;
                    })
                );
                if (setting.groupByRegion)
                    _forceBase.links(regionLinks);
            }

            _forceBase.resume();
            _force.resume();
        }

        // Move d to be adjacent to the cluster node.
        function cluster(alpha) {

            parentHash.forEach(function(k, d) {
                d.links = 0;
            });

            return function(d) {
                blink(d, setting.childLife > 0);
                if (!d.parent || !d.visible)
                    return;

                var node = d.parent,
                    l,
                    r,
                    x,
                    y;

                if (node == d) return;
                node.links++;

                x = d.x - node.x;
                y = d.y - node.y;
                l = Math.sqrt(x * x + y * y);
                r = radius(nr(d)) / 2 + (nr(node) + setting.padding);
                if (l != r) {
                    l = (l - r) / (l || 1) * (alpha || 1);
                    x *= l;
                    y *= l;

                    d.x -= x;
                    d.y -= y;
                }
                d.paths && (d.flash /* || d.paths.length > 2*/ ) && d.paths.push({
                    x: d.x,
                    y: d.y
                });
            };
        }

        function clusterParent(alpha) {

            return function(d) {
                if (!d.region || !d.visible)
                    return;

                var node = d.region,
                    l,
                    r,
                    x,
                    y;

                if (node == d) return;
                node.links++;

                x = d.x - node.x;
                y = d.y - node.y;
                l = Math.sqrt(x * x + y * y);
                r = nr(d) + (nr(node) + setting.padding * 2);
                if (l != r) {
                    l = (l - r) / (l || 1) * (alpha || 1);
                    x *= l;
                    y *= l;

                    d.x -= x;
                    d.y -= y;
                }
            };
        }


        function updateExtHistogram() {
            if (!lHis || lHis.selectAll(".colStack").empty())
                return;

            lHis.selectAll(".colStack")
                .attr("transform", function(d) {
                    return "translate(" + [d.x += d.w / 2, 0] + ")";
                })
                .filter(function(d) {
                    return d.x > d.max;
                })
                .remove();
        }

        function lme(d) {
            selectedExt = d.value;

            tooltip.html([
                "<b style='text-shadow: 1px 1px 1px #000; color:",
                d.value.color,
                "'>", d.key, "</b>",
                "<hr>",
                "Number of contract: <b>",
                d.value.now.length,
                "</b><br/>Money ($): <b>",
                th(d3.sum(d3.values(d.value.values))),
                "M.</b><br/>"
            ].join(''));
            tooltip.style("display", "block");
            updateLegend();
        }

        function lml() {
            selectedExt = null;
            tooltip.style("display", null);
            updateLegend();
        }

        function lmm(d) {
            moveToolTip(d, d3.event);
        }

        function legColor(d) {
            var ext = selectedExt;
            if (!ext && selected && selected.type == typeNode.child && selected.ext)
                ext = selected.ext;

            return ext ? ext == d.value ? d.value.color : colorless : d.value.color;
        }

        function initLegend() {
            if (!layer)
                return;

            var mt = 48,
                ml = 5, //_w * .01,
                h2 = _h / 2 - mt,
                w3 = _w / 3;

            lLeg = (lLeg || layer.append("g"))
                .attr("width", w3)
                .attr("height", h2)
                .attr("transform", "translate(" + [ml, mt] + ")");

            lLeg.selectAll("*").remove();

            var g = lLeg.selectAll(".gLeg")
                .data(extHash.entries(), function(d) {
                    return d.key;
                });

            g.exit().remove();

            g.enter().append("g")
                .on("mouseover", lme)
                .on("mousemove", lmm)
                .on("mouseout", lml)
                .attr("class", "gLeg")
                .attr("transform", function(d, i) {
                    return "translate(" + [0, i * 18] + ")";
                })
                .style("visibility", "hidden");
            g.append("rect")
                .attr("height", 16)
                .style("fill", legColor);
            g.append("text")
                .attr("class", "gttLeg")
                .style("font-size", "13px")
                .text(function(d) {
                    return d.key;
                })
                .style("fill", function(d) {
                    return d3.rgb(d.value.color).brighter().brighter();
                });

            g.append("text")
                .attr("class", "gtLeg")
                .style("font-size", "11px")
                .attr("transform", "translate(" + [2, 12] + ")");
        }

        function sortLeg(b, a) {
            return d3.ascending(a.value.now.length, b.value.now.length);
        }

        function sortLegK(b, a) {
            return d3.ascending(a.key, b.key);
        }

        function updateLegend() {
            if (!lLeg || lLeg.empty())
                return;

            var g = lLeg.selectAll(".gLeg");

            function wl(d) {
                return d.value.now.length;
            }

            g.selectAll(".gtLeg")
                .text(wl);

            var wb = d3.max(g.selectAll(".gtLeg"), function(d) {
                return d[0].clientWidth || d[0].getComputedTextLength();
            }) + 4;

            g.selectAll("rect")
                .style("fill", legColor)
                .attr("width", wb);

            g.selectAll(".gttLeg")
                .attr("transform", "translate(" + [wb + 2, 12] + ")");

            g.sort(sortLegK).sort(sortLeg)
                .style("visibility", function(d, i) {
                    return !wl(d) || i * 18 > lLeg.attr("height") ? "hidden" : "visible";
                })
                //.transition()
                //.duration(500)
                .attr("transform", function(d, i) {
                    return "translate(" + [0, i * 18] + ")";
                });

        }

        var tooltip;

        function showToolTip(d) {
            var res;
            var itemInflu, itemPos;
            //        console.log(d);
            if (!d) {
                tooltip.style("display", "none");
                return;
            }
            for (var k in influenceValue) {

                if (influenceValue[k].areaPY == d.nodeValue.shortName) {
                    itemInflu = influenceValue[k].area;
                    itemPos = parseInt((influenceValue[k].cei).replace(/,/, ''));;

                }
            }
            if (tooltip.style("display") == "none") {
                //            console.log(itemPos == undefined||itemPos == 'NaN'||itemInflu == undefined)
                if (itemPos == undefined || itemPos == 'NaN' || itemInflu == undefined) return;
                res = [];

                //            console.log(itemPos,itemInflu)
                //            if (d.type == typeNode.parent) {
                res = [
                    d.img && d.img.width > 0 && d.img.height > 0 ? d.img.outerHTML : "",
                    " 地区: <b>",
                    itemInflu,
                    "</b><hr/>影响?: <b>",
                    th(itemPos)
                    //                    "M.</b><br/>Borrowed ($): <b>",
                    //                    th(d.nodeValue.borrowed),
                    //                    "M.</b><br/>"
                ];
                //            }
                //

                tooltip.html(res.join(''));
                tooltip.style("display", "block");
            }
        }

        function moveToolTip(d, event) {
            event = event || d3.event;
            //        console.log(event)
            if (d && event) {
                tooltip
                    .style("top", event.pageY > _h / 2 ? (event.pageY - tooltip.node().clientHeight - 16) + "px" : (event.pageY + 16) + "px")
                    .style("left", event.pageX > _w / 2 ? (event.pageX - tooltip.node().clientWidth - 16) + "px" : (event.pageX + 16) + "px");
            }
            updateLegend();
        }

        var $ceitip, $selecPath;

        function movem(d) {

            var item = arguments.length > 1 && arguments[1] instanceof HTMLCanvasElement ? arguments[1] : this;
            d = null;
            //        console.log(d)
            if (selected) {
                //            console.log(selected);
                var od = selected;
                if (contain(od, d3.mouse(item)))
                    d = od;
                //            console.log(d)
                if (!d) {
                    od && (od.fixed &= 3);
                    selected = null;
                    d3.select("body").style("cursor", "default");

                }
            } else
                d = getNodeFromPos(d3.mouse(item));

            if ($selecPath) {
                var elc = $selecPath.node.getAttribute("oldColor");
                $selecPath.attr("style", elc);
            }

            if (d) {
                selected = d;
                d.fixed |= 4;
                d3.select("body").style("cursor", "pointer");
            } else {
                //查看是否在某个地?
                //d = getNodeFromProcence(pName)[0];
                var pObject = isPointInChinaPro(d3.mouse(item));
                var HEBEIObject = isPointInHeBeiPro(d3.mouse(item));
                if (pObject || HEBEIObject) {
                    if (HEBEIObject) {
                        pObject = HEBEIObject;

                    }


                    var cei = pObject.cei || 0;
                    if (!pObject.properties.name) {


                    } else {



                        var pid = "path_" + pObject.properties.name;

                        if (pObject.id == "河北") {
                            pid = "path_HEBEI";
                        }
                        $selecPath = Snap.select("#" + pid);

                        var oldColor = $selecPath.node.getAttribute("style");
                        $selecPath.attr("style", "fill:rgb(250,192,39)");
                        if (oldColor) {
                            $selecPath.attr("oldColor", oldColor);
                        }

                        if (!$ceitip) {
                            $ceitip = $("<span class='ceitip'>").css({
                                position: "absolute",
                                left: d3.mouse(item)[0],
                                top: d3.mouse(item)[1]
                            });
                            $ceitip.appendTo($("body"));

                        }
                        $ceitip.css({
                            position: "absolute",
                            left: d3.mouse(item)[0] + 15,
                            top: d3.mouse(item)[1],
                            height: 20,
                            //background:"#f11b44",
                            // color:"#fff",
                            padding: "2px 3px",
                            "box-shadow": "1px 1px 2px 1px black"
                        }).show("slow");
                        console.log(cei);
                        $ceitip.html(pObject.id + ":" + (typeof cei == 'string' ? parseInt(cei.replace(/,/g, '')) : cei));





                    }
                } else {
                    $(".ceitip").hide("slow");
                    $ceitip = null;


                    $selecPath = null;
                    //Snap.select("#"+pid).attr("fill","red");
                }

                return;
            }
            showToolTip(d, d3.event);
            moveToolTip(d, d3.event);
        }


        function move() {


            lastEvent.translate = d3.event.translate.slice(0);
            lastEvent.scale = d3.event.scale;

            var tl = lastEvent.translate[0] / lastEvent.scale,
                tt = lastEvent.translate[1] / lastEvent.scale;

            xW.range([-tl, -tl + _w / lastEvent.scale])
                .domain([0, _w]);
            yH.range([-tt, -tt + _h / lastEvent.scale])
                .domain([0, _h]);

            valid = false;
        }

        vis.runShow = function(data, dom, w, h, asetting) {
            if (typeof _worker !== "undefined")
                clearTimeout(_worker);

            _data = data.sort(function(a, b) {
                return d3.ascending(a, b)
            });
            _w = w;
            _h = h;

            if (!_data || !_data.length)
                return;

            setting = asetting;

            extColor = d3.scale.category20();
            _parentKey = function(d) {
                return d.key;
            };
            _childKey = function(d) {
                return d.id;
            };

            dateRange = d3.extent(data, function(d) {
                return d.date;
            });

            layer = dom;
            layer.selectAll("*").remove();

            lastEvent = {
                translate: [0, 0],
                scale: 1
            };

            xW = d3.scale.linear()
                .range([0, w])
                .domain([0, w]);

            yH = d3.scale.linear()
                .range([0, h])
                .domain([0, h]);

            var zoom = d3.behavior.zoom()
                .scaleExtent([.1, 8])
                .scale(1)
                .translate([0, 0])
                .on("zoom", move);

            canvas = layer.append("canvas")
                .text("This browser don't support element type of Canvas.")
                .attr("id", "mainCanvas")
                .attr("width", w)
                .attr("height", h)
                .call(zoom)
                .node();

            tooltip = tooltip || d3.select(document.body).append("div").attr("class", "tooltip");
            tooltip.style("display", "none");

            ctx = canvas.getContext("2d");

            bufCanvas = document.createElement("canvas");
            bufCanvas.width = w;
            bufCanvas.height = h;

            bufCtx = bufCanvas.getContext("2d");
            bufCtx.globalCompositeOperation = 'lighter';

            bufCtx.font = "normal normal " + setting.sizeParent / 2 + "px Tahoma";
            bufCtx.textAlign = "center";

            d3.select(dom.node().parentNode).select("#s").remove();
            lHis = null;
            lCom = null;
            lLeg = null;

            layer = d3.select(dom.node().parentNode).append("div").attr("id", "s")
                .append("svg").attr('width', w).attr("height", h)
                .on('mousemove.tooltip', movem);

            layer.append("g")
                //            .call(setting.zoom ? setting.zoom : zoom)
                .on('mousemove.tooltip', movem)
                .append("rect")
                .attr("width", w)
                .attr("height", h)
                .attr("x", 0)
                .attr("y", 0)
                .style("fill", "#ffffff")
                .style("fill-opacity", 0);



            links = d3.map({});
            regionLinks = [];
            nodes = initNodes(_data);
            //        console.log(nodes);
            _force = (_force || d3.layout.force()
                    .stop()
                    .size([w, h])
                    .friction(.75)
                    .gravity(0)
                    //.charge(function(d) {return -1 * radius(nr(d)); } )
                    .charge(-.5)
                    .on("tick", tick))
                .nodes([]);

            zoomScale = d3.scale.linear()
                .range([5, 1])
                .domain([.1, 1]);

            setting.padding = setting.padding || 0;
            _forceBase = (_forceBase || d3.layout.force()
                    .stop()
                    .size([w, h])
                    //.linkDistance(setting.padding)
                    .gravity(setting.padding * .001)
                    .charge(function(d) {
                        return setting.groupByRegion ? -(Math.pow(d.size, 2) + setting.padding * (d.links || 1)) : -(setting.padding + d.size) * 8;
                    }))
                .nodes([]);

            //initLegend();

            run();
            _force.start();
            _forceBase.start();
        };

        vis.pauseShow = function() {
            pause = true;
        };

        vis.stopShow = function() {
            stop = true;
        };

        vis.resumeShow = function() {
            pause = false;
        };

        vis.resize = function(w, h) {
            _w = w;
            _h = h;
        }
    })(vis || (vis = {}));

    (function() {
        var w, h,
            _data,
            //        fy = "1126China",
            //        fy = "1127China",
            div;
        var fy = "/cas/casData/screenJson?type=articleCity";
        newJSONURL = "/cas/xhs/articleDetail/main.do?method=getReprintByTime";
        var zbGuid = getQueryString("zbGuid");
        var eventID = getQueryString("eventID");
        var pubTimeStart = getQueryString("pubTimeStart");
        var pubTimeEnd = getQueryString("pubTimeEnd");
        //    console.log("showTip"+showTip);
        if(zbGuid==null &&pubTimeStart==null&&pubTimeEnd==null&&eventID==null){
//        fy = '/cas/casData/screenJson?type=articleCity';
//        fy = '/cas/casData/screenJson?type=getReprintRouteByTime';
            newJSONURL = "/cas/xhs/articleDetail/main.do?method=getReprintByTime";
//        fy = "1127China";
        }else if(eventID ==null){

            pubTimeStart=pubTimeStart==null?"":pubTimeStart;
            pubTimeEnd=pubTimeEnd==null?"":pubTimeEnd;

            newJSONURL = '/cas/xhs/bigScreen/main.do?method=getEarthAreaByZbGuid&zbGuid='+zbGuid+"&pubTimeStart="+pubTimeStart+"&pubTimeEnd="+pubTimeEnd;
            if(zbGuid!=''&&pubTimeStart==''&&pubTimeStart==''){
                newProvince = "/cas/xhs/bigScreen/main.do?method=getProvinceCeiByGuid&zbGuid="+zbGuid;
            }else if(pubTimeStart!=''){
                newProvince = "/cas/xhs/bigScreen/main.do?method=getProvinceCeiByGuidAndTime&zbGuid="+zbGuid+"&pubTimeStart="+pubTimeStart+"&pubTimeEnd="+pubTimeEnd;
            }

        }else{
            newJSONURL = '/wcm/bigdata.do?field=&modelid=getEventListForBig&serviceid=eventtrace&topvalue=5&typeid=event&user_id=admin&department=admin&eventid='+eventID;

        }
        //    console.log(fy);
        wbc.getByIsoId = function(id) {
            var c,
                l = wbc[1].length;
            while (--l > -1) {
                c = wbc[1][l];
                if (c.iso2Code == id)
                    return c;
            }
            return null;
        };

        var countriesCounter = 0,
            countries = {},
            countryByIndex = [],
            failCountryCoord,
            needPaintCapital = [],
            projects;


        function coord(x, y) {
            var c = [x, y];
            return {
                x: {
                    valueOf: function() {
                        var p = projection(c);
                        return p[0];
                    }
                },
                y: {
                    valueOf: function() {
                        var p = projection(c);
                        return p[1];
                    }
                }
            }
        }


        // return object country
        function initCounty(key, value) {
            var c = countries[key] || (countries[key] = {
                key: key,
                name: value,
                shortName: value.split(',')[0],
                borrowed: 0,
                supplied: 0,
                id: countriesCounter++,
                toString: function(full) {
                    return full ? this.name : this.shortName;
                }
            });

            if (countries[key]) {
                if (!countries[key].count) {
                    countries[key].count = 0;
                }
                countries[key].count++;
            }
            if (c)

                if (!countryByIndex[c.id]) {
                    var cc = wbc.getByIsoId(c.key);
                    if (!cc) {
                        cc = failCountryCoord[c.key];
                        if (!cc) {
                            cc = {
                                longitude: -50 + (10 * failCountryCoord.length++),
                                latitude: 80,
                                capitalCity: c.shortName
                            };
                            failCountryCoord[c.key] = cc;
                        }
                    }
                    cc.init = true;
                    c.capitalCity = {
                        name: cc.capitalCity,
                        coord: coord(cc.longitude, cc.latitude)
                    };
                    c.x = c.capitalCity.coord.x;
                    c.y = c.capitalCity.coord.y;

                    needPaintCapital.push(cc);

                    //preload(c);
                }
            return countryByIndex[c.id] = c;
        }

        function initProcurement(d) {
            return {
                category: d['Procurement Category'],
                method: d['Procurement Method'],
                type: d['Procurement Type']
            };
        }

        function initContract(d) {
            return {
                desc: d['Contract Description'],
                date: Date.parse(d['Contract Signing Date'])
            };
        }

        function initProject(d) {
            return projects[d['Project ID']] || (projects[d['Project ID']] = {
                name: d['Project Name'],
                id: d['Project ID'],
                toString: function() {
                    return this.name;
                }
            });
        }

        function value() {
            return this.basevalue || 0;
        }

        function initItem(d) {
            // Convert strings to numbers.
            d.value = d.basevalue = parseInt(d["Total Contract Amount (USD)"].substring(1));
            d.valueOf = value;

            d.borrower = initCounty(d["Borrower Country Code"], d["Borrower Country"]);
            d.borrower.borrowed += d.value;
            d.supplier = initCounty(d["Supplier Country Code"], d["Supplier Country"]);
            d.supplier.supplied += d.value;
            d.sector = d["Major Sector"];
            d.product = d['Product line'];
            d.procurement = initProcurement(d);
            d.contract = initContract(d);
            d.year = d['Fiscal Year'];
            d.project = initProject(d);
            d.id = d['WB Contract Number'] + d.project.id + d.supplier.key + d.borrower.key;
            // d.date = d.contract.date;
            d.date = d.pubTime;
            d.asdate = Date.parse(d['As of Date']);
            return d;
        }

        function clone(d) {
            var newItem = {};

            for (var key in d) {
                if (!d.hasOwnProperty(key))
                    continue;
                newItem[key] = d[key];
            }
            return newItem;
        }

        function sortByCSD(a, b) {
            return b.contract.date - a.contract.date;
        }

        var sizes = d3.scale.linear()
            .range([4, 400]);

        projection = d3.geo.mercator();

        var path = d3.geo.path()
            .projection(projection);

        function ctr(d) {
            return "translate(" + projection([d.longitude, d.latitude]) + ")";
        }

        var zoom = d3.behavior.zoom()
            .on("zoom", function() {
                projection.translate(d3.event.translate).scale(d3.event.scale);
                feature.attr("d", path);
                circle.attr("transform", ctr);


            });

        var fsvg = d3.select(document.body)
            .append("div")
            .attr("id", "map")
            .append("svg");

        var feature = fsvg
            .selectAll("path.feature");

        var circle;

        request = function(error, data) {
            var l, a, b;
            projects = {};
            countriesCounter = 0;
            countries = {};
            countryByIndex = [];
            failCountryCoord = {
                length: 0
            };
            needPaintCapital = [];

            data = data.map(initItem);
            l = data.length;
            sizes.domain(d3.extent(data));

            _data = [];
            while (--l > -1) {
                a = data[l];
                a.size = sizes(+a);
                b = clone(a);
                a.parent = a.supplier;
                b.parent = b.borrower;
                a.date = a.date - stepDate /*/2*/ ;
                _data.push(a);
                _data.push(b);
            }
            _data.sort(sortByCSD);

            div = div || d3.select(document.body).append("div").attr("id", "c");
            w = document.body.clientWidth;
            h = document.body.clientHeight;


            projection
            //地图大小调整
                .scale(w / 1.82)
                .translate([w / 2, h / 1.38]).center([107, 31]);
            zoom.translate(projection.translate())
                .scale(projection.scale())
                .scaleExtent([h / 6, h]);

            feature.attr("d", path);

            fsvg.selectAll("circle").remove();

            circle = fsvg.selectAll("circle")
                .data(needPaintCapital)
                .enter()
                .append("circle")
                .attr("r", 2)
                .attr("fill", "#fff")
                //.attr("fill", "url(#light)")
                .attr("transform", ctr)
                .style("fill", function(d, i) {
                    return "#fff";
                });



            setting.zoom = zoom;
            //
            bufCanvas = null;
            canvas = null, ctx = null,
                bufCanvas = null, bufCtx = null;

            vis.runShow(_data, div, w, h, setting);
            //vis.stopShow();

        }









        //d3.json("world-countries.json", function (error, collection) {



console.log(newJSONURL);
        queue().defer(d3.json, newJSONURL)
            .await(function(error, data) {
                var mapRecords = data.Records ? data.Records : data.RECORDS;
                mapRecords.forEach(function(_data, index, array) {
                    var r = Math.ceil(Math.random() * 255);
                    var g = Math.ceil(Math.random() * 255);
                    var b = Math.ceil(Math.random() * 255);
                    _data['Major Sector'] = "rgb(" + r + "," + g + "," + b + ")";
                });


                 var chinaMap = new MAP(function(){
                     MAPDATA = this.mapData;
                     HEBEIDATA = this.mapHBData;
                     saveDATA = _DATA = mapRecords.slice(0);
                     getDATA(function(data) {
                        request(error, data);
                     })
                 });
                 chinaMap.CEIURL=newProvince;
                 chinaMap.CHINAPURL="chinap.json";
                 chinaMap.HEBEIURL="json/hebei.json";
//                 chinaMap.isDraw=false;
                 chinaMap.show();
               
            });
        //});

    })();
    </script>
    <script>
    $(function() {
        $('.linkShow').on('click', function() {
                var self = $(this);
                var type = self.attr('data-link');
                if (type == 1) {
                    setting.showEdge = true;
                    self.attr('data-link', '2');
                } else if (type == 2) {
                    setting.showEdge = false;
                    self.attr('data-link', '1');
                }
            })
            // console.log(influenceValue);




    })
    </script>
</body>

</html>
