<!DOCTYPE HTML>
<html>
  <head>
  <script src="js/bee.js"></script>
    <script src="v2/api.v2.js"></script>
    <script src="js/d3.v3.min.js"></script>
    <script src="js/queue.v1.js"></script>
    
    <style type="text/css">
        .we-pm-icon{cursor:pointer;-webkit-animation: scaleout .8s infinite ease-in-out;animation: scaleout .8s infinite ease-in-out;}
        .we-pm-icon {
            position: absolute;
            z-index: 64;
            /*box-shadow:5px 5px 5px 2px yellow;*/
            width: 9px !important;
            height: 9px !important;
            margin-left: -13px;
            margin-top: -25px;
            background: linear-gradient(#f4f5f2, rgb(230,250,0));
            /* background-image: none; */
            border-radius: 100%;
            box-shadow: 0px 0px 5px 3px #cbe208;
        }
        @-webkit-keyframes scaleout {
            0% { -webkit-transform: scale(1.0) }
            100% {
                -webkit-transform: scale(1.5);
                opacity: 0.8;
            }
        }
        @keyframes scaleout {
            0% { -webkit-transform: scale(1.0) }
            100% {
                -webkit-transform: scale(1.5);
                opacity: 0.8;
            }
        }

    </style>
    <script>
      function initialize() {
        var earth = new WE.map('earth_div');
        //数据地球配置
        //WE.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(earth);
        //自然地球配置
        WE.tileLayer('http://data.webglearth.com/natural-earth-color/{z}/{x}/{y}.jpg', {
        
        // WE.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {

          tileSize: 256,
          bounds: [[-85, -180], [85, 180]],
          minZoom: 1,
          maxZoom: 16,
          attribution: 'trs.com.cn',
          tms: true
        }).addTo(earth);
        earth.setView([39.9,116.3], 2.5);


          queue().defer(d3.json,"data/72HoursCities.json").defer(d3.json,"/cas/casData/screenJson?type=ThreedaysArticle").defer(d3.json, "data/capitals.json").await(function(error,cities,events,capitals){
              if(error)throw error;
              cities.forEach(function(item,index){
                  //将城市json中的地域信息 在 事件json中匹配，将匹配到的标题赋值到城市标题中
                  //item.TITLE = events[item.AREA].TITLE;
                  events.Records.forEach(function(ca_item,_index){
                      if(ca_item.region == item.AREANAME){
                          if(item.TITLE && item.TITLE!=''){
                              cities.push({
                                  "AREANAME": item.AREANAME,
                                  "INDEX": cities.length+1,
                                  "AREA": "001016",
                                  "HOTNUM": "4543",
                                  "LOADDATE": "2016-10-20",
                                  "TITLE" : ca_item.title
                              });
                          }else{
                              item.TITLE = ca_item.title;
                          }


                      }
                  })

              });
              cities.forEach(function(item,index){

                  capitals.contents.forEach(function(_item,_index){
                      //如果省会json 的省会名 与 城市json的地域名匹配，将这个省的经纬度赋值到城市上
                      if(_item.province == item.AREANAME){
                          item.latitude = _item.latitude;
                          item.longitude = _item.longitude;
                      }

                  });
              });

          var index = 0;
          var points = {};
          var interval = setInterval(function(){
                if(index ==0){
                    var _marker = WE.marker([cities[index].latitude,cities[index].longitude]).addTo(earth);
                    _marker.bindPopup("<font style='text-align:center;' color=orange>["+cities[index].AREANAME+"]</font>&nbsp;"+cities[index].TITLE, {maxWidth: 120, closeButton: false}).openPopup();
                    earth.panTo([cities[index].latitude,cities[index].longitude],100);
                }else{
                    for(;index<cities.length;index++){
                        if(cities[index].latitude && cities[index].TITLE){
                            var _marker = WE.marker([cities[index].latitude,cities[index].longitude]).addTo(earth);
                            _marker.bindPopup("<font style='text-align:center;' color=orange>["+cities[index].AREANAME+"]</font>&nbsp;"+cities[index].TITLE, {maxWidth: 120, closeButton: false}).openPopup();
                            earth.panTo([cities[index].latitude,cities[index].longitude],100);

                            break;
                        }

                    }
                }

//              console.log(cities[1].latitude,cities[1].longitude+','+cities[0].AREANAME+','+cities[0].TITLE)
//            console.log("index"+index);
                index++;
                if(index>=cities.length){
                    //clearInterval(interval);
                    index = 0;
                }
                setTimeout(function(){
                    earth.removeMarker(_marker);
                },1000);


            },1000);



        });

          var before = null;
          requestAnimationFrame(function animate(now) {
              var c = earth.getPosition();
              var elapsed = before? now - before: 0;
              before = now;
              earth.setCenter([c[0], c[1] + 0.1*(elapsed/30)]);
              requestAnimationFrame(animate);
          });

          //startsbg(document.getElementById("bg"));
          html5_3d_animation(document.getElementById("bg"),{
            window_width: '1600',
            window_height: '768',
            window_background: '#00113F',
            star_count: '1000',
            star_color: '#FBFFAF',
            star_depth: '100'
        });

      }
    </script>
    <style>
      html, body{padding: 0; margin: 0; background-color: black;}
      #earth_div{top: 0; right: 0; bottom: 0; left: 0; position: absolute !important;}
      #bg{width:100%;height:100%;width:1600px;height:768px;}
    </style>
    <title>WebGL Earth API: Markers</title>
  </head>
  <body onload="initialize()">
    <div id="earth_div"></div>
    <canvas id="bg" width=1600 height=768></canvas>
  </body>
</html>
